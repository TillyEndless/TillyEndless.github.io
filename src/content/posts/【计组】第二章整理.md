---
title: ã€è®¡ç»„ã€‘ç¬¬äºŒç« æ•´ç†
published: 2024-10-29
description: 'å†…å®¹ä¸°æ»¡çš„ä¸€ç« ï¼Œä¼šç»§ç»­æ¢³ç†é‡æ•´ç¬”è®°æ¶æ„ã€‚'
image: ''
tags: [è®¡ç»„]
category: 'notes'
draft: false 
lang: ''
---

**ç¬”è®°è¯´æ˜**ï¼šè‡ªå·±å¯¹ä¸Šè¯¾PPTçš„æ‘˜è¦+zjuå¤§ä½¬ç¬”è®°çš„è¡¥å……ã€‚æœ‰äº›åœ°æ–¹å†™çš„ä¸æ˜¯å¾ˆä¸¥è°¨æˆ–é¡ºåºä¹±ï¼Œåé¢ä¼šæ•´ç†ã€‚

**æ„Ÿè°¢-ç¬”è®°å‚è€ƒ**ï¼šhttps://xuan-insr.github.io/computer_organization/2_instructions/ ï¼ˆå’¸é±¼æš„çš„ä»£ç ç©ºé—´ï¼‰

---
## ç›®å½• 
- [ç« èŠ‚ç†è§£ç»´åº¦](#%E7%AB%A0%E8%8A%82%E7%90%86%E8%A7%A3%E7%BB%B4%E5%BA%A6)
- [Outline](#outline)
- [Introduction](#introduction)
- [Arithmetic Operations](#arithmetic-operations)
- [Oprands](#oprands)
  * [alignment restriction](#alignment-restriction)
  * [Signed and unsigned numbers](#signed-and-unsigned-numbers)
  * [è¡¥ç  2's complement](#%E8%A1%A5%E7%A0%81-2s-complement)
- [Representing Instructions](#representing-instructions)
  * [æŒ‡ä»¤æ€»è¡¨](#%E6%8C%87%E4%BB%A4%E6%80%BB%E8%A1%A8)
  * [RISC-V æŒ‡ä»¤æ ¼å¼è¡¨](#risc-v-%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F%E8%A1%A8)
  * [å››ç§RISC-VæŒ‡ä»¤æ ¼å¼](#%E5%9B%9B%E7%A7%8Drisc-v%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F)
    + [Rå‹æŒ‡ä»¤](#r%E5%9E%8B%E6%8C%87%E4%BB%A4)
    + [Iå‹æŒ‡ä»¤](#i%E5%9E%8B%E6%8C%87%E4%BB%A4)
    + [Så‹æŒ‡ä»¤](#s%E5%9E%8B%E6%8C%87%E4%BB%A4)
- [Logic Operations](#logic-operations)
- [Cå’Œæ±‡ç¼–è½¬æ¢](#c%E5%92%8C%E6%B1%87%E7%BC%96%E8%BD%AC%E6%8D%A2)
  * [å¸¸è§Branchä¸¾ä¾‹](#%E5%B8%B8%E8%A7%81branch%E4%B8%BE%E4%BE%8B)
  * [Jump register & jump address tableï¼ˆswitché€»è¾‘ï¼‰](#jump-register--jump-address-tableswitch%E9%80%BB%E8%BE%91)
    + [jalrå’Œjalè¯­æ³•(æ— æ¡ä»¶è·³è½¬)](#jalr%E5%92%8Cjal%E8%AF%AD%E6%B3%95%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC)
    + [switché€»è¾‘ï¼ˆæ±‡ç¼–è¯­è¨€ï¼‰](#switch%E9%80%BB%E8%BE%91%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80)
    + [Basic Blocksï¼ˆåŸºæœ¬å—ï¼‰](#basic-blocks%E5%9F%BA%E6%9C%AC%E5%9D%97)
- [Supporting Procedures è¿‡ç¨‹è°ƒç”¨](#supporting-procedures-%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8)
  * [Procedure Call Instructions](#procedure-call-instructions)
  * [è¿‡ç¨‹è°ƒç”¨å’Œæ ˆ](#%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%92%8C%E6%A0%88)
  * [å¯„å­˜å™¨ç”¨é€”æ€»ç»“è¡¨](#%E5%AF%84%E5%AD%98%E5%99%A8%E7%94%A8%E9%80%94%E6%80%BB%E7%BB%93%E8%A1%A8)
  * [å››ç§å¯»å€æ–¹å¼](#%E5%9B%9B%E7%A7%8D%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F)
- [ç«äº‰ä¸åŒæ­¥](#%E7%AB%9E%E4%BA%89%E4%B8%8E%E5%90%8C%E6%AD%A5)
- [Linker && Loader](#linker--loader)
- [å¾…æ•´ç†](#%E5%BE%85%E6%95%B4%E7%90%86)

## ç« èŠ‚ç†è§£ç»´åº¦
ä¸‰ç§è¯­è¨€ï¼š é«˜çº§è¯­è¨€ã€æ±‡ç¼–è¯­è¨€ã€æœºå™¨è¯­è¨€
1. é«˜çº§è¯­è¨€ï¼ˆCè¯­è¨€ï¼‰â€”â€”â€”â€”æ±‡ç¼–è¯­è¨€
2. æ±‡ç¼–è¯­è¨€ï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰â€”â€”â€”â€”æœºå™¨è¯­è¨€ï¼ˆæœºå™¨ç ï¼‰
## Outline
* Introduction
* Operations of the computer hardware 
* Operands of the computer hardware
* Signed and a numbers
* Representing instructions in the computer
* Logical operations 
* Instructions for making decision
* Supporting procedures in computer hardware
* Instruction addressing

## Introduction
 instruction set: RISC-V
 P6
 RISC VS CISC å¯¹æ¯”è¡¨æ ¼
 P9
 Stored-program concept
 P12 
## Arithmetic Operations

## Oprands
*  RISC-V has a 32 Ã— 64-bit register file
   *  Use for frequently accessed data
   *  64-bit data is called a â€œdoublewordâ€
       *  32 x 64-bit general purpose registers x0 to x31
   *  32-bit data is called a â€œwordâ€ **4ä¸ªå­—èŠ‚ä¸€ä¸ªâ€å­—â€œ**
![æˆªå±2024-10-17 15.39.38](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2015.39.38.png)
åœ¨å‡½æ•°è°ƒç”¨ä¸­ï¼Œå¯„å­˜å™¨ x0 æ˜¯å¦è¢«ä¿ç•™å–å†³äºè°ƒç”¨çº¦å®šã€‚
![æˆªå±2024-10-17 15.46.14](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2015.46.14.png)
![æˆªå±2024-10-17 15.46.29](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2015.46.29.png)
![æˆªå±2024-10-17 15.46.37](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2015.46.37.png)

* RISC-V does not require words to be aligned in 
memory
### alignment restriction
åœ¨ä¸€äº› architecture ä¸­ï¼Œword çš„èµ·å§‹åœ°å€å¿…é¡»æ˜¯ word å¤§å°çš„æ•´å€æ•°ï¼Œdword åŒæ ·ã€‚
RISC-V å…è®¸ä¸å¯¹é½çš„å¯»å€ï¼Œä½†æ˜¯æ•ˆç‡ä¼šä½ã€‚
![æˆªå±2024-10-17 16.24.54](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2016.24.54.png)
RISC-V ä½¿ç”¨ **little endian å°ç«¯ç¼–å€**ï¼šå½“æˆ‘ä»¬ä» 0x1000 è¿™ä¸ªåœ°å€è¯»å‡ºä¸€ä¸ª dword æ—¶ï¼Œæˆ‘ä»¬è¯»åˆ°çš„å®é™…ä¸Šæ˜¯ 0x1000~0x1007 è¿™ 8 ä¸ªå­—èŠ‚ï¼Œå¹¶å°† 0x1000 å­˜å…¥å¯„å­˜å™¨ä½ä½ï¼Œ0x1007 å­˜å…¥é«˜ä½ã€‚
ï¼ˆä¸¾ä¾‹ï¼šä¸€ä¸ª2è¿›åˆ¶æ•´æ•°ï¼Œä½8ä½å­˜å…¥memoryä½åœ°å€ï¼Œé«˜å…«ä½å­˜å…¥æ›´é«˜åœ°å€memoryï¼‰

### Signed and unsigned numbers
1. Unsigned Binary Integers: ![æˆªå±2024-10-17 17.06.03](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2017.06.03.png)
2. 2s-Complement Signed Integers:![æˆªå±2024-10-17 17.06.34](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2017.06.34.png)
![æˆªå±2024-10-17 17.07.02](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2017.07.02.png)
    Signed Negation:Complement and add 1
    
P29 Sign Extension
![æˆªå±2024-10-17 17.13.15](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2017.13.15.png)

### è¡¥ç  2's complement
å‰å¯¼ 0 è¡¨ç¤ºæ­£æ•°ï¼Œå‰å¯¼ 1 è¡¨ç¤ºè´Ÿæ•°ã€‚

å› æ­¤åœ¨å°†ä¸è¶³ 64 ä½çš„æ•°æ®è½½å…¥å¯„å­˜å™¨æ—¶ï¼Œå¦‚æœæ•°æ®æ˜¯æ— ç¬¦å·æ•°ï¼Œåªéœ€è¦**ä½¿ç”¨ 0 å°†å¯„å­˜å™¨çš„å…¶ä»–éƒ¨åˆ†å¡«å……** (zero extension)ï¼›è€Œå¦‚æœæ˜¯ç¬¦å·æ•°ï¼Œåˆ™éœ€è¦ç”¨æœ€é«˜ä½å³ç¬¦å·ä½å¡«å……å‰©ä½™éƒ¨åˆ†ï¼Œç§°ä¸º**ç¬¦å·æ‰©å±•** (sign extension)ã€‚

åœ¨æŒ‡ä»¤ä¸­çš„**lw , lh , lb**ä½¿ç”¨ sign extensionï¼Œè€Œ**lwu , lhu , lbu**ä½¿ç”¨ zero extensionã€‚
ï¼ˆ**åç **ï¼š1's complementï¼‰

P19
base register & offset
![æˆªå±2024-10-17 16.53.38](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2016.53.38.png)
P22 constant representation:
* constant oprands
* immediate operands

P23 Summary
![æˆªå±2024-10-17 17.00.00](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2017.00.00.png)


## Representing Instructions
### æŒ‡ä»¤æ€»è¡¨
![æŒ‡ä»¤è¡¨](/img/CO/1654864713202-23520b16-be27-484e-8f08-39aa863679ba.png)
* åœ¨ RISC æŒ‡ä»¤é›†ä¸­ï¼Œåªæœ‰ load ç³»åˆ—å’Œ store ç³»åˆ—æŒ‡ä»¤èƒ½å¤Ÿè®¿é—®å†…å­˜ã€‚
* RISC-V çš„è·³è½¬æŒ‡ä»¤çš„ offset æ˜¯åŸºäº**å½“å‰æŒ‡ä»¤**çš„åœ°å€çš„åç§»ï¼›è¿™ä¸åŒäºå…¶ä»–ä¸€äº›æ±‡ç¼–æ˜¯åŸºäºä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»çš„ã€‚å³å¦‚æœæ˜¯**è·³è½¬è¯­å¥** PC å°±ä¸ +4 äº†ï¼Œè€Œæ˜¯ç›´æ¥ +offsetã€‚
* lw , lwu ç­‰æ“ä½œéƒ½ä¼šæ¸…é›¶é«˜ä½ï¼šå› ä¸ºRISC-Vçš„å¯„å­˜å™¨æ˜¯64ä½çš„ï¼Œå½“æ‰§è¡Œlw/lwuæ“ä½œæ—¶ï¼Œå®ƒä¼šå°†32ä½çš„æœ‰ç¬¦å·æ•°æ®åŠ è½½åˆ°å¯„å­˜å™¨çš„ä½32ä½ï¼ŒåŒæ—¶è‡ªåŠ¨æ¸…é›¶é«˜32ä½ï¼Œä»¥é¿å…å¯„å­˜å™¨ä¸­æ®‹ç•™çš„é«˜ä½æ•°æ®å¹²æ‰°æ–°çš„32ä½æ•°æ®ã€‚

### RISC-V æŒ‡ä»¤æ ¼å¼è¡¨
![æŒ‡ä»¤è¡¨](/img/CO/1653461947307-ab399754-6565-46f5-8554-641c7def91a4.png)
![æˆªå±2024-10-17 18.33.41](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2018.33.41.png)
- é‡ç‚¹ï¼šå¯„å­˜å™¨çš„çº¯æ•°å­—æ˜ å°„ï¼ŒRISC-VæŒ‡ä»¤ä½å®½ï¼Œopcodeå³ä¸ºoperation codeï¼ˆæ“ä½œç ï¼‰
* å…¶ä¸­ I å‹æŒ‡ä»¤æœ‰ä¸¤ä¸ªæ¡ç›®ï¼›è¿™æ˜¯å› ä¸ºç«‹å³æ•°ç§»ä½æ“ä½œ slli , srli , srai å¹¶ä¸å¯èƒ½å¯¹ä¸€ä¸ª 64 ä½å¯„å­˜å™¨è¿›è¡Œå¤§äº 63 ä½çš„ç§»ä½æ“ä½œï¼Œå› æ­¤ 12 ä½ imm ä¸­åªæœ‰å 6 ä½èƒ½å®é™…è¢«ç”¨åˆ°ï¼Œå› æ­¤å‰é¢ 6 ä½è¢«ç”¨æ¥ä½œä¸ºä¸€ä¸ªé¢å¤–çš„æ“ä½œç å­—æ®µï¼Œå¦‚ä¸Šå›¾ä¸­ç¬¬äºŒä¸ª I æ¡ç›®é‚£æ ·ã€‚å…¶ä»– I å‹æŒ‡ä»¤é€‚ç”¨ç¬¬ä¸€ä¸ª I æ¡ç›®ã€‚
* å¦å¤–ï¼Œä¸ºä»€ä¹ˆ SB å’Œ UJ ä¸å­˜ç«‹å³æ•°ï¼ˆä¹Ÿå°±æ˜¯åç§»ï¼‰çš„æœ€ä½ä½å‘¢ï¼Ÿï¼ˆå…³æ³¨è¡¨æ ¼ï¼Œå¯ä»¥å‘ç°åªåŒ…æ‹¬ i[12:1] æˆ–è€… i[20:1]ï¼Œç¼ºå¤± i[0]ï¼‰å› ä¸ºï¼Œåç§»çš„æœ€åä¸€ä½ä¸€å®šæ˜¯ 0ï¼Œå³åœ°å€ä¸€å®šæ˜¯ 2 å­—èŠ‚å¯¹é½çš„ï¼Œå› æ­¤æ²¡æœ‰å¿…è¦ä¿å­˜

### å››ç§RISC-VæŒ‡ä»¤æ ¼å¼
![æˆªå±2024-10-17 18.40.33](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2018.40.33.png)
* Instruction fields
    * opcode: operation code
    * rd: destination register number
    * funct3: 3-bit function code (additional opcode)
    * rs1: the first source register number
    * rs2: the second source register number
    * funct7: 7-bit function code (additional opcode)
#### Rå‹æŒ‡ä»¤
![](/img/CO/3.png)
#### Iå‹æŒ‡ä»¤
![æˆªå±2024-10-17 18.49.16](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2018.49.16.png)
![](/img/CO/2.png)
#### Så‹æŒ‡ä»¤
![æˆªå±2024-10-17 18.50.02](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2018.50.02.png)

* P40 : UJ å’Œ SB type åœ°å€æ˜¯åŒæ•°çš„ï¼Œèˆå»ç¬¬ä¸€ä½ï¼ˆæ²¡æœ‰é›¶ä½ï¼‰ï¼ŒåŠ ä¸Šç¬¬åäºŒä½ï¼Œæ‰©å¤§èŒƒå›´ã€‚

## Logic Operations
![](/media/17291428769621/17291649815452.png)
shift left & rightéƒ½æ˜¯ç«‹å³æ•°æŒ‡ä»¤ï¼Ÿ

![](/media/17291428769621/17297414321545.png)

 Â· åŸºå€å¯»å€ï¼šld x19, 0(x10) # temp reg x19 = A[i]  å…¶ä¸­çš„0ï¼ˆx10ï¼‰å°±æ˜¯åŸºå€å¯»å€
 Â· å¸¸è§å¼ºåˆ¶è·³è½¬ï¼šbeq x0, x0, Loop æˆ– beq x0, x0, Exit

* jalrï¼ˆJump And Link Registerï¼‰æŒ‡ä»¤ï¼š
![](/media/17291428769621/17297537249051.png)
![](/media/17291428769621/17297540362309.png)![](/media/17291428769621/17297542048265.png)
* PCï¼šå½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¼šè‡ªåŠ¨é€’å¢4ã€‚**å½“é‡åˆ°è·³è½¬ï¼ˆå¦‚ JALã€JALRï¼‰ã€åˆ†æ”¯æˆ–å‡½æ•°è°ƒç”¨ç­‰æŒ‡ä»¤æ—¶ï¼ŒPC ä¼šè¢«æ˜¾å¼ä¿®æ”¹ä»¥è·³è½¬åˆ°å…¶ä»–ä½ç½®æ‰§è¡Œã€‚**
* å…³äºAddress table:ï¼ˆä»¥x6ä¸ºtableåŸºåœ°å€ä¸ºä¾‹ï¼‰
![](/media/17291428769621/17297548751023.png)
![](/media/17291428769621/17297548872444.png)

## Cå’Œæ±‡ç¼–è½¬æ¢
### å¸¸è§Branchä¸¾ä¾‹
1. if
```zsh
beq x21, x22, L1  # go to L1 if i equals j
```
2. if-then-else
```zsh
bne x22, x23, Else # go to Else if i != j
...
beq x0, x0, EXIT # go to Exit
Else: sub x19, x20, x21 # f = g - h ( Executed if i â‰  j else) 
Exit: # the first instruction of the next C
```
3. LOOPs
```zsh
Loop: ...
    add x22, x22, x23 # i = i + j
    bne x22, x21, Loop # å¼€å¤´loop, æœ«å°¾ go to Loop if i != h
```
4. while
```zsh
Loop: ...
    bne x9, x24, Exit # go to Exit if save[i] != k
      ...
    addi x22, x22, 1 # i += 1
      ...
    beq x0, x0, Loop # go to Loop å¼ºåˆ¶å¾ªç¯
Exit
```
5. å…¶ä»–
* blt rs1, rs2, L1
```zsh
if (rs1 < rs2) branch to instruction labeled L1
```
* bge rs1, rs2, L1
```zsh
if (rs1 >= rs2) branch to instruction labeled L1
```
### Jump register & jump address tableï¼ˆswitché€»è¾‘ï¼‰
#### jalrå’Œjalè¯­æ³•(æ— æ¡ä»¶è·³è½¬)
1. jalr:
åŸºæœ¬æ ¼å¼ä¸º **jalr rd, offset(rs1)**
* rdï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨è¿”å›åœ°å€ã€‚å¦‚æœç›®æ ‡å¯„å­˜å™¨æ˜¯x0ï¼Œåˆ™ä¸ä¿å­˜è¿”å›åœ°å€ã€‚
* offsetï¼šä¸€ä¸ªç«‹å³æ•°åç§»é‡ï¼ˆé€šå¸¸æ˜¯0æˆ–å°çš„æ•´æ•°ï¼‰ï¼Œç”¨äºç›¸å¯¹äºrs1çš„è·³è½¬ã€‚
* rs1ï¼šæºå¯„å­˜å™¨ï¼ŒåŒ…å«è·³è½¬çš„åŸºåœ°å€
* jalræŒ‡ä»¤é€šå¸¸ç”¨äº**å®ç°å‡½æ•°è°ƒç”¨çš„è¿”å›**ï¼Œè€Œä¸æ˜¯ä½œä¸ºè°ƒç”¨è€…ï¼ˆcallerï¼‰æ¥è¿›è¡Œ**å‡½æ•°è°ƒç”¨ï¼ˆjalï¼‰**

ä½¿ç”¨ç¤ºä¾‹ï¼š
```zsh
# å‡è®¾è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›
# å‡½æ•°åœ°å€åœ¨x1å¯„å­˜å™¨ä¸­ï¼Œè¿”å›åœ°å€ä¿å­˜åˆ°x2å¯„å­˜å™¨
jalr x2, 0(x1)   # è·³è½¬åˆ°x1å¯„å­˜å™¨ä¸­çš„åœ°å€ï¼Œè¿”å›åœ°å€å­˜å‚¨åœ¨x2
... # å‡½æ•°ä»£ç 
# å‡½æ•°ç»“æŸåè¿”å›
jalr x0, 0(x2)   # ä½¿ç”¨jalræŒ‡ä»¤è¿”å›åˆ°ä¹‹å‰è°ƒç”¨çš„ä½ç½®
```
2. jal:
åŸºæœ¬æ ¼å¼ä¸º **jal rd, offset**
* rdï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œé€šå¸¸ç”¨äºä¿å­˜è¿”å›åœ°å€ã€‚è¿”å›åœ°å€æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¾›åç»­è¿”å›ä½¿ç”¨ã€‚
* offsetï¼šä¸€ä¸ªç«‹å³æ•°åç§»é‡ï¼Œè¡¨ç¤º**ç›¸å¯¹äºå½“å‰æŒ‡ä»¤åœ°å€çš„è·³è½¬è·ç¦»**ã€‚è¿™ä¸ªå€¼å¯ä»¥æ˜¯æ­£æ•°ï¼ˆå‘å‰è·³è½¬ï¼‰æˆ–è´Ÿæ•°ï¼ˆå‘åè·³è½¬ï¼‰

ä½¿ç”¨ç¤ºä¾‹ï¼š
```zsh
# å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸ºfunctionçš„å‡½æ•°
function:
    ... # å‡½æ•°ä»£ç   
    jalr x0, 0(x1)   # è¿”å›åˆ°è°ƒç”¨ç‚¹
main:
    jal x1, function  
        # è·³è½¬åˆ°functionï¼Œè¿”å›åœ°å€ä¿å­˜åœ¨x1
    # ç»§ç»­æ‰§è¡Œmainçš„åç»­ä»£ç 
```
#### switché€»è¾‘ï¼ˆæ±‡ç¼–è¯­è¨€ï¼‰
![](/img/CO/4.png)
å…¶ä¸­ç¬¬ä¸€è¡Œç›¸å½“äºswitchçš„defaultè¯­å¥ï¼ŒL0-L3ç›¸å½“äºswitchçš„caseè·³è½¬è¯­å¥ã€‚è¢«caseçš„æ˜¯kçš„å€¼ã€‚
è½¬å†™Cï¼š
```c
switch (k) {
        case 0:
            *f = i + j;  // k = 0ï¼Œæ‰§è¡Œ f = i + j
            break;
        case 1:
            *f = g + h;  // k = 1ï¼Œæ‰§è¡Œ f = g + h
            break;
        case 2:
            *f = g - h;  // k = 2ï¼Œæ‰§è¡Œ f = g - h
            break;
        case 3:
            *f = i - j;  // k = 3ï¼Œæ‰§è¡Œ f = i - j
            break;
        default:
            break; 
    }
```
**æ±‡ç¼–&C è½¬æ¢æé†’**ï¼š
```zsh
slli x7, x25, 3 # temp reg x7 = 8 * k (0<=k<=3) 
add x7, x7, x6 # x7 = address of JumpTable[k]
```
å¦‚æœæ˜¯è‡ªå·±æŠŠCè½¬å†™æ±‡ç¼–ï¼Œæ³¨æ„**åŸºå€åç§»é‡ä¸º8bitå€æ•°**ï¼Œå¦‚ç¬¬ä¸€è¡Œä»£ç æ‰€ç¤ºå¤„ç†ã€‚


#### Basic Blocksï¼ˆåŸºæœ¬å—ï¼‰
p58
* å®šä¹‰ï¼šä¸€ç»„æ²¡æœ‰åˆ†æ”¯ï¼ˆè·³è½¬ï¼‰æŒ‡ä»¤çš„è¿ç»­æŒ‡ä»¤åºåˆ—
![](/media/17291428769621/17297573763056.png)
![](/media/17291428769621/17297574004820.png)



## Supporting Procedures è¿‡ç¨‹è°ƒç”¨
P59 ç¨‹åº/å‡½æ•°è¢«ç”¨æ¥æ„å»ºç¨‹åºç»“æ„
* ä¸€ä¸ªå­˜å‚¨çš„å­ç¨‹åºï¼Œæ ¹æ®æä¾›çš„å‚æ•°æ‰§è¡Œç‰¹å®šä»»åŠ¡ï¼Œä½¿ç¨‹åºæ›´æ˜“äºç†è§£ï¼Œå…è®¸ä»£ç é‡ç”¨
* å…­ä¸ªæ­¥éª¤ï¼š
1. å°†å‚æ•°æ”¾ç½®åœ¨ç¨‹åºå¯ä»¥è®¿é—®çš„åœ°æ–¹
2. å°†æ§åˆ¶æƒè½¬ç§»ç»™ç¨‹åºï¼šè·³è½¬åˆ°(jump to)
3. è·å–ç¨‹åºæ‰€éœ€çš„å­˜å‚¨èµ„æº
4. æ‰§è¡Œæ‰€éœ€çš„ä»»åŠ¡
5. å°†ç»“æœå€¼æ”¾ç½®åœ¨è°ƒç”¨ç¨‹åºå¯ä»¥è®¿é—®çš„åœ°æ–¹
6. å°†æ§åˆ¶æƒè¿”å›åˆ°åŸå§‹ç‚¹

### Procedure Call Instructions
* Instruction for procedures: jal ( jump-and-link )
    - Caller **jal x1, ProcedureAddress**
        + x1æ˜¯ç›®æ ‡å¯„å­˜å™¨ï¼Œé€šå¸¸åœ¨RISC-Vä¸­è¢«ç§°ä¸ºraï¼ˆReturn Addressï¼‰ã€‚
        + åœ¨è·³è½¬ä¹‹å‰ï¼ŒjalæŒ‡ä»¤ä¼šå°†å½“å‰æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼ˆå³è¿”å›åœ°å€ï¼‰å­˜å‚¨åœ¨x1å¯„å­˜å™¨ä¸­ã€‚è¿™æ„å‘³ç€å½“ProcedureAddressæ‰§è¡Œå®Œåï¼Œå¯ä»¥é€šè¿‡jalrï¼ˆJump and Link Registerï¼‰æŒ‡ä»¤ä»x1å¯„å­˜å™¨è¿”å›ï¼ˆè§ä¸‹é¢çš„jalræŒ‡ä»¤ï¼‰
* Procedure return: jalr ( jump and link register )
    - Callee **jalr x0, 0(x1)**
        + ä¸ä¿å­˜è¿”å›åœ°å€ï¼šx0 ä¸º0ï¼Œä¸ä¼šä¿å­˜è¿”å›åœ°å€ã€‚å› æ­¤åœ¨å®Œæˆè¿™ä¸ªè·³è½¬åï¼Œæ— æ³•è¿”å›åˆ°è·³è½¬ä¹‹å‰çš„ä½ç½®

### è¿‡ç¨‹è°ƒç”¨å’Œæ ˆ
RISC-V çº¦å®šï¼š
* x5 - x7 å’Œ x28 - x31 ï¼štemp reg
    - è¿™äº›å¯„å­˜å™¨åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­å¯ä»¥è‡ªç”±ä½¿ç”¨ï¼Œä¸è¦æ±‚è¢«è°ƒç”¨è€…ï¼ˆcalleeï¼‰åœ¨ä½¿ç”¨å®ƒä»¬åæ¢å¤åŸå€¼ã€‚æ‰€ä»¥è°ƒç”¨è€…ï¼ˆcallerï¼‰å¿…é¡»æ‰¿æ‹…è¿™äº›å¯„å­˜å™¨å€¼å¯èƒ½åœ¨å‡½æ•°è°ƒç”¨åè¢«æ”¹å˜çš„é£é™©ã€‚
    - å¦‚æœå¸Œæœ›è°ƒç”¨åï¼Œä»ä¿ç•™è¿™äº›æ•°æ®ï¼Œå°±éœ€è¦åœ¨è°ƒç”¨å‡½æ•°å‰å°†è¿™äº›æ•°æ®ä¿å­˜åˆ°å†…å­˜æˆ–å…¶ä»–ä¿å­˜å¯„å­˜å™¨ä¸­ã€‚
* x8 - x9 å’Œ x18 - x27 ï¼š saved reg
    - è°ƒç”¨çº¦å®šè¦æ±‚è¢«è°ƒç”¨è€…ï¼ˆcalleeï¼‰åœ¨ä½¿ç”¨è¿™äº›å¯„å­˜å™¨ä¹‹å‰ä¿å­˜å®ƒä»¬çš„å€¼ï¼Œå¹¶åœ¨å‡½æ•°è¿”å›å‰æ¢å¤ã€‚
    - å› æ­¤ï¼Œè°ƒç”¨è€…ä¸éœ€è¦è‡ªå·±ä¿å­˜è¿™äº›å¯„å­˜å™¨çš„å€¼ï¼Œè¢«è°ƒç”¨è€…åœ¨ä½¿ç”¨è¿™äº›å¯„å­˜å™¨æ—¶å¿…é¡»å…ˆå°†å®ƒä»¬ä¿å­˜åˆ°æ ˆä¸­ï¼Œåœ¨å‡½æ•°è¿”å›å‰å†å°†ä¿å­˜çš„æ•°æ®æ¢å¤åˆ°å¯„å­˜å™¨ã€‚
* x10 - x17 æ˜¯ 8 ä¸ªå‚æ•°å¯„å­˜å™¨ï¼Œ**å‡½æ•°è°ƒç”¨**çš„å‰ 8 ä¸ª**å‚æ•°**ä¼šæ”¾åœ¨è¿™äº›å¯„å­˜å™¨ä¸­
    - å¦‚æœå‚æ•°è¶…è¿‡ 8 ä¸ªçš„è¯å°±éœ€è¦æ”¾åˆ°æ ˆä¸Šï¼ˆæ”¾åœ¨ fp ä¸Šæ–¹ï¼Œ fp + 8 æ˜¯ç¬¬ 9 ä¸ªå‚æ•°ï¼Œ fp + 16 çš„ç¬¬ 10 ä¸ªï¼Œä»¥æ­¤ç±»æ¨ï¼‰ã€‚
    - åŒæ—¶ï¼Œè°ƒç”¨è¿‡ç¨‹çš„**è¿”å›å€¼**ä¹Ÿä¼šæ”¾åˆ°è¿™äº›å¯„å­˜å™¨ä¸­ï¼ˆå½“ç„¶ï¼Œå¯¹äº C è¯­è¨€è¿™ç§åªèƒ½æœ‰ä¸€ä¸ªè¿”å›å€¼çš„è¯­è¨€ï¼Œå¯èƒ½åªä¼šç”¨åˆ° x10 ï¼‰ã€‚
* x1 ï¼šä¿å­˜è¿”å›åœ°å€ï¼Œæ‰€ä»¥ä¹Ÿå« **ra** 
* æ ˆæŒ‡é’ˆï¼ˆspï¼‰æ˜¯ x2 ï¼›å§‹ç»ˆæŒ‡å‘**æ ˆé¡¶**å…ƒç´ ã€‚æ ˆä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ã€‚
    - å †æ ˆï¼š**ä»é«˜åœ°å€å¾€ä½åœ°å€å»ºè®¾â€”â€”>push:æŒ‡é’ˆä¸‹ç§» åœ°å€å‡å°ï¼Œpop:æŒ‡é’ˆä¸Šç§» åœ°å€å¢åŠ â€”â€”>è¿›æ ˆå‡ï¼Œå…¥æ ˆåŠ **
    - addi sp, sp, -24 , sd x5, 16(sp) , sd x6, 8(sp) , sd x20, 0(sp) å¯ä»¥å®ç°å°† x5, x6, x20 å‹æ ˆã€‚
    - 64ä½RISC-Væ¶æ„ä¸­ï¼Œsp çš„åç§»é‡æ˜¯ä»¥8å­—èŠ‚ä¸ºå•ä½çš„ï¼Œå³æ ˆä¸­**ä¸€ä¸ªå…ƒç´ çš„å¤§å°**ä¸º **8 å­—èŠ‚ï¼ˆ64ä½ï¼‰**
* ä¸€äº›ç¼–è¯‘å™¨ä¸­ x3 ç”¨æ¥æŒ‡å‘**é™æ€å˜é‡åŒº**ï¼Œç§°ä¸º **global pointer ï¼ˆgpï¼‰** ã€‚
* ä¸€äº›ç¼–è¯‘å™¨ä¸­ x8 æŒ‡å‘ **activation record** çš„ç¬¬ä¸€ä¸ª dwordï¼Œæ–¹ä¾¿è®¿é—®å±€éƒ¨å˜é‡ï¼›å› æ­¤ x8 ä¹Ÿç§°ä¸º **frame pointer ï¼ˆfpï¼‰** ã€‚åœ¨è¿›å…¥å‡½æ•°æ—¶ï¼Œ**ç”¨ sp å°† fp åˆå§‹åŒ–**ã€‚
    - fp çš„æ–¹ä¾¿æ€§åœ¨äºåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­**å¯¹å±€éƒ¨å˜é‡çš„æ‰€æœ‰å¼•ç”¨ç›¸å¯¹äº fp çš„åç§»éƒ½æ˜¯å›ºå®šçš„**ï¼Œä½†æ˜¯å¯¹ sp ä¸ä¸€å®šã€‚å½“ç„¶ï¼Œå¦‚æœè¿‡ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ ˆçš„å˜åŒ–æˆ–è€…æ ¹æœ¬æ²¡æœ‰å±€éƒ¨å˜é‡ï¼Œé‚£å°±æ²¡æœ‰å¿…è¦ç”¨ fp äº†ã€‚
ä»¥ä¸‹ä¸ºæ€»ç»“ï¼š
### å¯„å­˜å™¨ç”¨é€”æ€»ç»“è¡¨
![æˆªå±2024-10-17 14.52.43](/img/CO/1654054605190-66992a62-3995-4285-8002-c28a0a8e9073.png)
å…¶ä¸­ "preserved on call" çš„æ„æ€æ˜¯ï¼Œæ˜¯å¦ä¿è¯è°ƒç”¨å‰åè¿™äº›å¯„å­˜å™¨çš„å€¼ä¸å˜ã€‚
![æˆªå±2024-10-17 14.52.43](/img/CO/1654866071308-dc8851c8-a41c-404f-830d-3aae477775df.png)


* leaf procedureï¼šæ²¡æœ‰è¿›ä¸€æ­¥çš„å‡½æ•°è°ƒç”¨

ç†è§£ğŸŒ°ï¼š
![æˆªå±2024-10-17 14.25.44](/media/17291428769621/111.png)
å»ºè®®å­¦ä¹ ä»ä¾‹å­å…¥æ‰‹ï¼Œä»å…·è±¡åˆ°ç†è®ºæ›´å®¹æ˜“æ¥å—


### å››ç§å¯»å€æ–¹å¼
1. p82 PCç›¸å¯¹å¯»å€
![æˆªå±2024-10-17 14.52.43](/media/17291428769621/%E6%88%AA%E5%B1%8F2024-10-17%2014.52.43.png)
æœºå™¨ç ï¼š2000/2ï¼ˆå»é›¶ä½ï¼‰
32ä½æ•°å¯¹ï¼Œè€ƒè¯•é”™ä¸€ä½æ‰£åˆ†ï¼Œä¸è¦å†™æ¼æ•°å­—ï¼
2. P88 å››ç§å¯»å€æ–¹å¼
![](/media/17291428769621/17295631673679.png)

RISC-V æ”¯æŒ PC relative å¯»å€ã€ç«‹å³æ•°å¯»å€ ( lui )ã€é—´æ¥å¯»å€ ( jalr )ã€åŸºå€å¯»å€ ( 8(sp) )ç­‰

æ€»ç»“ï¼š
1.  ç«‹å³å¯»å€ï¼ˆImmediate Addressingï¼‰ï¼š
â€¢	æŒ‡ä»¤ä¸­åŒ…å«ä¸€ä¸ªç«‹å³æ•°ï¼Œè¯¥æ•°å€¼ç›´æ¥ä½œä¸ºæ“ä½œæ•°ä½¿ç”¨ã€‚
â€¢	ä¾‹å¦‚ï¼Œaddi x1, x0, 10ï¼Œå°†10ç›´æ¥åŠ åˆ°å¯„å­˜å™¨x0çš„å€¼ä¸Šå¹¶å­˜å‚¨åˆ°x1ä¸­ã€‚
2.	å¯„å­˜å™¨å¯»å€ï¼ˆRegister Addressingï¼‰ï¼š
â€¢	æ“ä½œæ•°ç›´æ¥ä»å¯„å­˜å™¨ä¸­è¯»å–ï¼ŒæŒ‡ä»¤ä¸­æŒ‡å®šå¯„å­˜å™¨ã€‚
â€¢	ä¾‹å¦‚ï¼Œadd x1, x2, x3ï¼Œå°†x2å’Œx3çš„å€¼ç›¸åŠ ï¼Œç»“æœå­˜å‚¨åˆ°x1ä¸­ã€‚
3.	åŸºå€å¯»å€ï¼ˆBase Addressingï¼‰ï¼š
â€¢	ä½¿ç”¨ä¸€ä¸ªå¯„å­˜å™¨ä½œä¸ºåŸºåœ°å€ï¼ŒåŠ ä¸Šä¸€ä¸ªåç§»é‡æ¥è®¡ç®—æœ‰æ•ˆåœ°å€ã€‚
â€¢	ä¾‹å¦‚ï¼Œlw x1, 4(x2)ï¼Œä»å¯„å­˜å™¨x2ä¸­è¯»å–åŸºå€ï¼ŒåŠ ä¸Š4ä½œä¸ºåç§»é‡ï¼Œä»å†…å­˜ä¸­åŠ è½½æ•°æ®åˆ°x1ã€‚
4.	åç§»å¯»å€ï¼ˆOffset Addressingï¼‰ï¼š
â€¢	ç±»ä¼¼äºåŸºå€å¯»å€ï¼Œä½¿ç”¨ä¸€ä¸ªå¯„å­˜å™¨å’Œä¸€ä¸ªç«‹å³æ•°ï¼ˆåç§»é‡ï¼‰æ¥è®¡ç®—åœ°å€ã€‚
â€¢	ä¾‹å¦‚ï¼Œsw x1, 8(x2)ï¼Œå°†x1çš„å€¼å­˜å‚¨åˆ°å†…å­˜åœ°å€x2 + 8ã€‚
5.	ç›¸å¯¹å¯»å€ï¼ˆPC-Relative Addressingï¼‰ï¼š
â€¢	ä½¿ç”¨å½“å‰ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰çš„å€¼åŠ ä¸Šä¸€ä¸ªåç§»é‡æ¥è®¡ç®—æœ‰æ•ˆåœ°å€ï¼Œé€šå¸¸ç”¨äºæ§åˆ¶æµæŒ‡ä»¤ã€‚
â€¢	ä¾‹å¦‚ï¼Œbeq x1, x2, labelï¼Œå¦‚æœx1ç­‰äºx2ï¼Œåˆ™è·³è½¬åˆ°labelä½ç½®ï¼Œlabelçš„åœ°å€æ˜¯PCåŠ ä¸ŠæŒ‡ä»¤ä¸­çš„åç§»é‡ã€‚
6.	ç›´æ¥å¯»å€ï¼ˆDirect Addressingï¼‰ï¼š
â€¢	ç›´æ¥æŒ‡å®šä¸€ä¸ªå†…å­˜åœ°å€ï¼Œé€šå¸¸ç”¨äºç‰¹å®šçš„I/Oæ“ä½œã€‚
â€¢	è¿™ç§æ–¹å¼åœ¨RISC-Vä¸­ä¸å¸¸è§ï¼Œä¸»è¦ç”¨äºç‰¹å®šçš„æŒ‡ä»¤ã€‚
7.	é—´æ¥å¯»å€ï¼ˆIndirect Addressingï¼‰ï¼š
â€¢	å¯»å€æ¨¡å¼é€šè¿‡ä¸€ä¸ªå¯„å­˜å™¨ä¸­å­˜å‚¨çš„åœ°å€æ¥ç¡®å®šæ“ä½œæ•°çš„å®é™…åœ°å€ã€‚
â€¢	ä¾‹å¦‚ï¼Œå…ˆå°†åœ°å€å­˜å…¥å¯„å­˜å™¨ï¼Œç„¶åé€šè¿‡è¯¥å¯„å­˜å™¨è®¿é—®å†…å­˜ã€‚


P89 
æŸ¥è¡¨åˆ¤æ–­æŒ‡ä»¤æ˜¯åŠ æ³•
rs2,rs1åœ¨æ±‡ç¼–è¯­è¨€ï¼šä¸è¦å†™åï¼

## ç«äº‰ä¸åŒæ­¥
P93
ï¼ˆæ•°æ®ï¼‰ç«äº‰â€”â€”>è§£å†³ï¼šåŒæ­¥æœºåˆ¶ åŸå­æ“ä½œï¼ˆç¡¬ä»¶æ”¯æŒï¼‰
atomic swap of registerï¼šä¸€æ¬¡è¯»å†™æ‰“åŒ…
![](/media/17291428769621/17298416812708.png)
![](/media/17291428769621/17298417167825.png)
     
P94 load reservedï¼šé¢„çº¦
rdï¼šç”¨äºç¡®è®¤æ“ä½œæ˜¯å¦æˆåŠŸï¼ˆä¸æˆåŠŸå¯èƒ½æ˜¯å› ä¸ºæ•°æ®æ”¹å˜/æœ‰å…¶ä»–è¿›ç¨‹åœ¨æ“ä½œï¼‰
è§£å†³ç«äº‰çš„æ–¹æ³•ï¼š![](/media/17291428769621/17295645628484.png)

æ³¨æ„ç†è§£ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«ã€‚

## Linker && Loader
P96 linkeré“¾æ¥å™¨  loader
ç¨‹åºç”±å¾ˆå¤šå¤´æ–‡ä»¶ç»„æˆï¼Œç”¨é“¾æ¥å™¨é“¾æ¥![](/media/17291428769621/17295652222832.png)
æ ¹æ®object file headerå°±èƒ½å®Œæˆé“¾æ¥ï¼Œè€Œä¸éœ€è¦æ‰«ææ•´ä¸ªç¨‹åºã€‚

image fileï¼šé•œåƒæ–‡ä»¶
åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œæ›´å¤šå¼€é”€
åŠ¨æ€é™æ€ï¼šçœ‹éœ€æ±‚
Lazy Linkageï¼šä¹Ÿæ˜¯åŠ¨æ€é“¾æ¥
P102 å³è¾¹æ˜¯ç¬¬äºŒæ¬¡ï¼ˆå·²ç»é“¾æ¥è¿‡äº†ï¼‰ï¼Œå·¦è¾¹æ˜¯ç¬¬ä¸€æ¬¡ï¼ˆåŠ¨æ€é“¾æ¥ï¼‰![](/media/17291428769621/17295664311183.png)

é—´æ¥è·³è½¬æ–¹å¼ï¼šä¸ç”¨ä¿®æ”¹ä¸»ç¨‹åºï¼Œè·³è½¬å¯¹åº”çš„è¡¨å‚¨å­˜åœ¨å†…å­˜é‡Œâˆš
P103 Javaè™šæ‹Ÿæœº
P108
![](/media/17291428769621/17295671624850.png)
å››ä¸ªè¿ç»­çš„mvæ„ä¹‰ï¼Ÿç›¸å½“äºå †æ ˆã€‚å‰ä¸¤ä¸ªmvï¼šæ”¾è¿›å¯„å­˜å™¨ä¿æŠ¤ï¼Œé¿å…è¢«è¦†ç›–ã€‚åä¸¤ä¸ªï¼šæ‹¿å‡ºä¸‹ä¸€ä¸ªäº¤æ¢çš„ä¸¤ä¸ªå‚æ•°ã€‚
å¯„å­˜å™¨å­˜å‚¨å¯ä»¥ä»£æ›¿å †æ ˆï¼Œé™¤éå¯„å­˜å™¨spilling
bugï¼šå…¶å®næ²¡æœ‰è¢«ä¿æŠ¤å¥½ï¼Œx11ä¼šè¢«ä¸‹ä¸€æ¬¡å¾ªç¯æ”¹å˜ã€‚mvåº”è¯¥æ”¾åœ¨sortä¸€å¼€å§‹ï¼ˆå¾ªç¯å¤–é¢ï¼‰
æ€ä¹ˆæ”¹ï¼Ÿ

Smaller is fasterï¼šå¯„å­˜å™¨æ•°é‡å°‘ï¼Œè®¿é—®å¿«

## å¾…æ•´ç†
åˆ†æ”¯å’Œå¾ªç¯
è¿‡ç¨‹è°ƒç”¨å’Œæ ˆ
